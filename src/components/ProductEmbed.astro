---
import { getCollection } from 'astro:content';
import { 
  getAffiliateMarketplaces, 
  formatAffiliatePrice, 
  calculateDiscountPercentage, 
  getPriorityBadge,
  isSponsored,
  getCTAText,
  type AffiliateProduct 
} from "../utils/affiliateUtils";
import ResponsiveImage from './ResponsiveImage.astro';

interface Props {
  slug: string;
  style?: 'card' | 'inline' | 'banner';
  showDescription?: boolean;
  showMarketplaces?: number; // Number of marketplaces to show (0 = all)
  className?: string;
}

const { slug, style = 'card', showDescription = true, showMarketplaces = 2, className = '' } = Astro.props;

// Get product data
let product = null;
let productData = null;

try {
  // Try Notion products first
  const notionProducts = await getCollection('products');
  product = notionProducts.find(p => p.data.properties.pSlug === slug);
  
  if (product) {
    const properties = product.data.properties;
    productData = {
      title: properties.pTitle,
      slug: properties.pSlug,
      price: properties.pPrice,
      originalPrice: properties.pOriginalPrice,
      imageUrl: properties.pImageURL1,
      description: properties.pDescription,
      category: Array.isArray(properties.pCategory) ? properties.pCategory : [properties.pCategory].filter(Boolean),
      affiliateCode: properties.pAffiliateCode,
      commissionRate: properties.pCommissionRate,
      discountCode: properties.pDiscountCode,
      specialOffer: properties.pSpecialOffer,
      ctaText: properties.pCTAText,
      priority: properties.pPriority,
      externalRating: properties.pExternalRating,
      soldCount: properties.pSoldCount,
      isSponsored: properties.pIsSponsored,
      targetAudience: Array.isArray(properties.pTargetAudience) ? properties.pTargetAudience : [properties.pTargetAudience].filter(Boolean),
      tokopediaUrl: properties.pTokopediaURL,
      shopeeUrl: properties.pShopeeURL,
      blibliUrl: properties.pBlibliURL,
      bukalapakUrl: properties.pBukalapakURL,
      lazadaUrl: properties.pLazadaURL,
      name: properties.pName,
      locale: properties.pLocale,
      verify: properties.pVerify,
    };
  } else {
    // Try MDX products
    const mdxProducts = await getCollection('productsMdx');
    product = mdxProducts.find(p => p.data.slug === slug);
    
    if (product) {
      productData = {
        title: product.data.title,
        slug: product.data.slug,
        price: product.data.price,
        originalPrice: '',
        imageUrl: product.data.imageUrl,
        description: product.data.description,
        category: Array.isArray(product.data.category) ? product.data.category : [product.data.category].filter(Boolean),
        affiliateCode: '',
        commissionRate: '',
        discountCode: '',
        specialOffer: '',
        ctaText: '',
        priority: '',
        externalRating: '',
        soldCount: '',
        isSponsored: false,
        targetAudience: [],
        tokopediaUrl: '',
        shopeeUrl: '',
        blibliUrl: '',
        bukalapakUrl: '',
        lazadaUrl: '',
        name: product.data.name || '',
        locale: product.data.locale,
        verify: '',
      };
    }
  }
} catch (error) {
  console.warn(`Failed to load product ${slug}:`, error);
}

if (!product || !productData) {
  // Return empty if product not found
  return;
}

const DEFAULT_IMAGE = 'https://res.cloudinary.com/dxyjku3eh/image/upload/v1754820661/Tanpa_judul_Presentasi__20250810_170926_0000_vdiibn.png';

// Create AffiliateProduct for utilities
const affiliateProduct: AffiliateProduct = {
  title: productData.title,
  slug: productData.slug,
  price: productData.price,
  originalPrice: productData.originalPrice,
  imageUrl: productData.imageUrl || DEFAULT_IMAGE,
  affiliateCode: productData.affiliateCode,
  commissionRate: productData.commissionRate,
  discountCode: productData.discountCode,
  specialOffer: productData.specialOffer,
  ctaText: productData.ctaText,
  priority: productData.priority,
  externalRating: productData.externalRating,
  soldCount: productData.soldCount,
  isSponsored: productData.isSponsored,
  targetAudience: productData.targetAudience,
  tokopediaUrl: productData.tokopediaUrl,
  shopeeUrl: productData.shopeeUrl,
  blibliUrl: productData.blibliUrl,
  bukalapakUrl: productData.bukalapakUrl,
  lazadaUrl: productData.lazadaUrl,
};

// Get affiliate data
const affiliateMarketplaces = getAffiliateMarketplaces(affiliateProduct, 'blog-embed');
const displayMarketplaces = showMarketplaces > 0 ? affiliateMarketplaces.slice(0, showMarketplaces) : affiliateMarketplaces;
const formattedPrice = formatAffiliatePrice(productData.price);
const formattedOriginalPrice = formatAffiliatePrice(productData.originalPrice);
const discountPercentage = calculateDiscountPercentage(productData.originalPrice || '', productData.price || '');
const priorityBadge = getPriorityBadge(productData.priority);
const sponsored = isSponsored(affiliateProduct);
---

{productData && (
  <div class={`affiliate-product-embed ${className}`} data-product-slug={productData.slug} data-embed-style={style}>
    
    {/* Card Style - Full featured product card */}
    {style === 'card' && (
      <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 relative">
        <!-- Sponsored Badge -->
        {sponsored && (
          <div class="absolute top-3 right-3 z-10 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">
            SPONSORED
          </div>
        )}
        
        <!-- Priority Badge -->
        {priorityBadge && !sponsored && (
          <div class={`absolute top-3 right-3 z-10 text-xs font-bold px-2 py-1 rounded-full ${priorityBadge.class}`}>
            {priorityBadge.text}
          </div>
        )}
        
        <!-- Discount Badge -->
        {discountPercentage > 0 && (
          <div class="absolute top-3 left-3 z-10 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
            -{discountPercentage}%
          </div>
        )}

        <div class="aspect-video relative">
          <ResponsiveImage
            src={productData.imageUrl || DEFAULT_IMAGE}
            alt={productData.title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
        
        <div class="p-4">
          <h3 class="font-bold text-lg text-gray-900 mb-2 line-clamp-2">
            <a href={`/products/${productData.slug}/`} class="hover:text-blue-600 transition-colors">
              {productData.title}
            </a>
          </h3>
          
          <!-- Rating & Sold Count -->
          {(productData.externalRating || productData.soldCount) && (
            <div class="flex items-center space-x-2 mb-2">
              {productData.externalRating && (
                <div class="flex items-center">
                  <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-sm text-gray-600 ml-1">{productData.externalRating}</span>
                </div>
              )}
              {productData.soldCount && (
                <span class="text-xs text-gray-500">({productData.soldCount} terjual)</span>
              )}
            </div>
          )}
          
          <!-- Price Section -->
          <div class="mb-3">
            <div class="flex items-center space-x-2">
              {formattedPrice && (
                <span class="text-lg font-bold text-green-600">{formattedPrice}</span>
              )}
              {formattedOriginalPrice && discountPercentage > 0 && (
                <span class="text-sm text-gray-500 line-through">{formattedOriginalPrice}</span>
              )}
            </div>
            
            {productData.specialOffer && (
              <div class="mt-1 text-xs text-red-600 font-medium">
                ðŸ”¥ {productData.specialOffer}
              </div>
            )}
          </div>
          
          {showDescription && productData.description && (
            <p class="text-sm text-gray-600 mb-3 line-clamp-2">{productData.description}</p>
          )}
          
          <!-- Marketplace Buttons -->
          {displayMarketplaces.length > 0 && (
            <div class="space-y-2">
              {displayMarketplaces.map((marketplace, index) => (
                <a
                  href={marketplace.affiliateUrl}
                  target="_blank"
                  rel="noopener noreferrer sponsored"
                  class={`w-full flex items-center justify-center gap-2 rounded-lg px-3 py-2 text-sm font-semibold transition-all duration-200 ${
                    marketplace.marketplace === 'tokopedia' ? 'bg-green-500 hover:bg-green-600 text-white' :
                    marketplace.marketplace === 'shopee' ? 'bg-orange-500 hover:bg-orange-600 text-white' :
                    marketplace.marketplace === 'blibli' ? 'bg-blue-500 hover:bg-blue-600 text-white' :
                    marketplace.marketplace === 'bukalapak' ? 'bg-red-500 hover:bg-red-600 text-white' :
                    'bg-purple-500 hover:bg-purple-600 text-white'
                  }`}
                  onclick={`window.affiliateUtils?.trackClick('${productData.slug}', '${marketplace.marketplace}', 'blog-embed')`}
                >
                  {getCTAText(affiliateProduct, marketplace.marketplace)}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </a>
              ))}
            </div>
          )}
          
          <div class="mt-3 pt-3 border-t border-gray-100">
            <a 
              href={`/products/${productData.slug}/`}
              class="text-sm text-blue-600 hover:text-blue-800 font-medium"
            >
              Lihat Detail Lengkap â†’
            </a>
          </div>
        </div>
      </div>
    )}

    {/* Inline Style - Compact horizontal layout */}
    {style === 'inline' && (
      <div class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow duration-300 relative">
        {sponsored && (
          <div class="absolute top-2 right-2 z-10 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">
            SPONSORED
          </div>
        )}
        
        <div class="flex">
          <div class="w-24 h-24 flex-shrink-0 relative">
            {discountPercentage > 0 && (
              <div class="absolute top-1 left-1 z-10 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded">
                -{discountPercentage}%
              </div>
            )}
            <ResponsiveImage
              src={productData.imageUrl || DEFAULT_IMAGE}
              alt={productData.title}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </div>
          
          <div class="flex-1 p-3">
            <h4 class="font-semibold text-gray-900 mb-1 line-clamp-1">
              <a href={`/products/${productData.slug}/`} class="hover:text-blue-600 transition-colors">
                {productData.title}
              </a>
            </h4>
            
            <div class="flex items-center justify-between">
              <div>
                {formattedPrice && (
                  <span class="text-sm font-bold text-green-600">{formattedPrice}</span>
                )}
                {formattedOriginalPrice && discountPercentage > 0 && (
                  <span class="text-xs text-gray-500 line-through ml-1">{formattedOriginalPrice}</span>
                )}
              </div>
              
              {displayMarketplaces.length > 0 && (
                <a
                  href={displayMarketplaces[0].affiliateUrl}
                  target="_blank"
                  rel="noopener noreferrer sponsored"
                  class={`px-2 py-1 text-xs font-semibold rounded transition-colors ${
                    displayMarketplaces[0].marketplace === 'tokopedia' ? 'bg-green-500 hover:bg-green-600 text-white' :
                    displayMarketplaces[0].marketplace === 'shopee' ? 'bg-orange-500 hover:bg-orange-600 text-white' :
                    displayMarketplaces[0].marketplace === 'blibli' ? 'bg-blue-500 hover:bg-blue-600 text-white' :
                    displayMarketplaces[0].marketplace === 'bukalapak' ? 'bg-red-500 hover:bg-red-600 text-white' :
                    'bg-purple-500 hover:bg-purple-600 text-white'
                  }`}
                  onclick={`window.affiliateUtils?.trackClick('${productData.slug}', '${displayMarketplaces[0].marketplace}', 'blog-embed')`}
                >
                  Beli
                </a>
              )}
            </div>
            
            {productData.externalRating && (
              <div class="flex items-center mt-1">
                <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                <span class="text-xs text-gray-600 ml-0.5">{productData.externalRating}</span>
              </div>
            )}
          </div>
        </div>
      </div>
    )}

    {/* Banner Style - Wide promotional banner */}
    {style === 'banner' && (
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-300 relative">
        {sponsored && (
          <div class="absolute top-3 right-3 z-10 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">
            SPONSORED
          </div>
        )}
        
        <div class="flex items-center p-4">
          <div class="w-16 h-16 flex-shrink-0 relative mr-4">
            {discountPercentage > 0 && (
              <div class="absolute -top-1 -left-1 z-10 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full">
                -{discountPercentage}%
              </div>
            )}
            <ResponsiveImage
              src={productData.imageUrl || DEFAULT_IMAGE}
              alt={productData.title}
              class="w-full h-full object-cover rounded-lg"
              loading="lazy"
            />
          </div>
          
          <div class="flex-1">
            <h4 class="font-bold text-lg text-gray-900 mb-1">
              <a href={`/products/${productData.slug}/`} class="hover:text-blue-600 transition-colors">
                {productData.title}
              </a>
            </h4>
            
            <div class="flex items-center space-x-3 mb-2">
              {formattedPrice && (
                <span class="text-lg font-bold text-green-600">{formattedPrice}</span>
              )}
              {formattedOriginalPrice && discountPercentage > 0 && (
                <span class="text-sm text-gray-500 line-through">{formattedOriginalPrice}</span>
              )}
              {productData.externalRating && (
                <div class="flex items-center">
                  <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-sm text-gray-600 ml-1">{productData.externalRating}</span>
                </div>
              )}
            </div>
            
            {productData.specialOffer && (
              <p class="text-sm text-red-600 font-medium mb-2">ðŸ”¥ {productData.specialOffer}</p>
            )}
            
            {showDescription && productData.description && (
              <p class="text-sm text-gray-600 mb-2 line-clamp-1">{productData.description}</p>
            )}
          </div>
          
          <div class="flex-shrink-0 ml-4">
            {displayMarketplaces.length > 0 && (
              <div class="space-y-1">
                {displayMarketplaces.slice(0, 2).map((marketplace) => (
                  <a
                    href={marketplace.affiliateUrl}
                    target="_blank"
                    rel="noopener noreferrer sponsored"
                    class={`block px-4 py-2 text-sm font-semibold rounded transition-all duration-200 text-center ${
                      marketplace.marketplace === 'tokopedia' ? 'bg-green-500 hover:bg-green-600 text-white' :
                      marketplace.marketplace === 'shopee' ? 'bg-orange-500 hover:bg-orange-600 text-white' :
                      marketplace.marketplace === 'blibli' ? 'bg-blue-500 hover:bg-blue-600 text-white' :
                      marketplace.marketplace === 'bukalapak' ? 'bg-red-500 hover:bg-red-600 text-white' :
                      'bg-purple-500 hover:bg-purple-600 text-white'
                    }`}
                    onclick={`window.affiliateUtils?.trackClick('${productData.slug}', '${marketplace.marketplace}', 'blog-embed')`}
                  >
                    {getCTAText(affiliateProduct, marketplace.marketplace)}
                  </a>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    )}
  </div>
)}

<!-- Tracking Script -->
<script define:vars={{ productSlug: productData?.slug, embedStyle: style }}>
  if (typeof window !== 'undefined' && window.affiliateUtils && productSlug) {
    // Track embed view
    window.affiliateUtils.trackView(productSlug, 'blog-embed');
  }
</script>