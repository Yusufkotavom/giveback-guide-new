---
import type { CollectionEntry } from "astro:content";
import MainLayout from "./MainLayout.astro";
import ResponsiveImage from "../components/ResponsiveImage.astro";
import { formatPrice } from "../utils/marketplaceUtils";

type Props = CollectionEntry<"services">["data"];

const { properties } = Astro.props as any;
const title = (properties.svTitle || "Service") + " - Services";
const image = properties.svImageURL1 || "/giveback-guide-placeholder.jpg";

const formattedPrice = formatPrice(properties.svPrice);

const fallbackImage = "/giveback-guide-placeholder.jpg";
oneSec: string[] = [properties.svImageURL1, properties.svImageURL2, properties.svImageURL3].filter((i: string) => !!i);
const images: string[] = oneSec.length > 0 ? oneSec : [fallbackImage];

const DEFAULT_WA_NUMBER = '085799520350';
const waHref = properties.svWhatsAppURL || `https://wa.me/62${DEFAULT_WA_NUMBER.replace(/^0/, '')}`;
---

<MainLayout title={title} description={properties.svReview || ''} image={image}>
  <div class="bg-white dark:bg-gray-900">
    <div class="mx-auto max-w-screen-xl grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8 px-0 lg:px-6">
      <main class="w-full">
        <section class="pt-6 px-4">
          <h1 class="mb-1 mt-2 text-4xl tracking-tight font-extrabold text-gray-900 dark:text-white">
            {properties.svTitle}
          </h1>
          <!-- WhatsApp primary CTA under title -->
          <div class="mb-3">
            <a href={waHref} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700">
              <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.965-.273-.099-.471-.149-.67.15-.198.297-.767.964-.94 1.162-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.521.149-.173.198-.297.298-.496.099-.198.05-.372-.025-.521-.074-.149-.669-1.611-.916-2.206-.242-.582-.487-.502-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.461 1.065 2.874 1.213 3.072.149.198 2.095 3.2 5.076 4.487.71.306 1.263.489 1.694.626.712.227 1.36.195 1.872.118.571-.085 1.758-.718 2.006-1.41.248-.694.248-1.289.173-1.41-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.999-3.648-.235-.374a9.86 9.86 0 01-1.51-5.234c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.12 1.03 6.988 2.899a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.886 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.33-1.654a11.88 11.88 0 005.713 1.456h.005c6.554 0 11.89-5.335 11.893-11.893a11.82 11.82 0 00-3.47-8.421"/></svg>
              <span class="font-semibold">Chat via WhatsApp</span>
              <span class="opacity-80">({DEFAULT_WA_NUMBER})</span>
            </a>
          </div>

          {formattedPrice && (
            <p class="mb-4 text-2xl font-bold text-green-600">{formattedPrice}</p>
          )}

          <ul class="space-y-4 text-left text-gray-500 dark:text-gray-400">
            {properties.svProvider && (
              <li class="flex items-center space-x-3 rtl:space-x-reverse">
                <span>Penyedia layanan:</span>
                <span class="font-medium text-gray-900 dark:text-white">{properties.svProvider}</span>
              </li>
            )}
            {properties.svWilayah && (
              <li class="flex items-center space-x-3 rtl:space-x-reverse">
                <span>Wilayah/Kabupaten Kota:</span>
                <div class="flex items-center flex-wrap gap-2">
                  {Array.isArray(properties.svWilayah)
                    ? properties.svWilayah.map((w) => (
                        <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">{w}</span>
                      ))
                    : <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">{properties.svWilayah}</span>
                  }
                </div>
              </li>
            )}
            {properties.svCategory && (
              <li class="flex items-center space-x-3 rtl:space-x-reverse">
                <span>Kategori:</span>
                <div class="flex items-center flex-wrap gap-2">
                  {Array.isArray(properties.svCategory)
                    ? properties.svCategory.map((c) => (
                        <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">{c}</span>
                      ))
                    : <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">{properties.svCategory}</span>
                  }
                </div>
              </li>
            )}
          </ul>
        </section>

        <!-- Featured Image -->
        <section class="py-6 px-4">
          <ResponsiveImage
            class="w-full drop-shadow-xl rounded-lg"
            src={images[0]}
            alt={properties.svTitle}
            fetchpriority="high"
            loading="eager"
            preset="hero"
          />
        </section>

        <section class="py-6 px-4">
          <h2 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Tentang layanan ini</h2>
          <article class="format format-sm sm:format-base lg:format-lg format-teal dark:format-invert">
            <slot />
          </article>
        </section>
      </main>

      <!-- Aside column (desktop only) -->
      <aside class="hidden lg:block pt-16">
        <div class="sticky top-24 space-y-6">
          <div class="bg-white border border-gray-200 rounded-lg p-6 dark:bg-gray-800 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Hubungi kami</h3>
            <div class="space-y-3">
              <a href={waHref} target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.965-.273-.099-.471-.149-.67.15-.198.297-.767.964-.94 1.162-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.521.149-.173.198-.297.298-.496.099-.198.05-.372-.025-.521-.074-.149-.669-1.611-.916-2.206-.242-.582-.487-.502-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.461 1.065 2.874 1.213 3.072.149.198 2.095 3.2 5.076 4.487.71.306 1.263.489 1.694.626.712.227 1.36.195 1.872.118.571-.085 1.758-.718 2.006-1.41.248-.694.248-1.289.173-1.41-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.999-3.648-.235-.374a9.86 9.86 0 01-1.51-5.234c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.12 1.03 6.988 2.899a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.886 9.884"/></svg>
                <span class="font-semibold">Chat via WhatsApp</span>
                <span class="opacity-80">({DEFAULT_WA_NUMBER})</span>
              </a>
              {properties.svURL && (
                <a href={properties.svURL} target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center rounded-lg px-4 py-3 text-sm font-medium text-gray-800 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300">Website Resmi</a>
              )}
              {properties.svMapsURL && (
                <a href={properties.svMapsURL} target="_blank" rel="noopener noreferrer" class="w-full inline-flex items-center justify-center rounded-lg px-4 py-3 text-sm font-medium text-gray-800 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-300">Lihat di Google Maps</a>
              )}
            </div>
            <p class="mt-4 text-xs text-gray-600 dark:text-gray-400">Kami mungkin mendapat komisi jika Anda bertransaksi melalui link ini. Nomor WhatsApp digunakan untuk komunikasi langsung.</p>
          </div>
        </div>
      </aside>
    </div>
  </div>
</MainLayout>